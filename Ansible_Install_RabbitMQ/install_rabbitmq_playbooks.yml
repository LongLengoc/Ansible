- hosts: localhost
  remote_user: cape
  become: yes
  tasks:
    - name: Import PackageCloud signing key
      command: wget -O - "https://packagecloud.io/rabbitmq/rabbitmq-server/gpgkey" | sudo apt-key add -
    
    - name: Apt update
      command: sudo apt-get update -y

    - name: Install prerequisites
      command: sudo apt-get install curl gnupg -y

    - name: Add RabbitMQ signing key
      command: curl -fsSL https://github.com/rabbitmq/signing-keys/releases/download/2.0/rabbitmq-release-signing-key.asc | sudo apt-key add -

    - name: Install apt HTTPS transport
      command: sudo apt-get install apt-transport-https

    - name: Add Bintray repositories 
      command: sudo tee /etc/apt/sources.list.d/bintray.rabbitmq.list <<EOF
              deb https://dl.bintray.com/rabbitmq-erlang/debian bionic erlang-22.x
              deb https://dl.bintray.com/rabbitmq/debian bionic main
              EOF

    - name: Update package
      command: sudo apt-get update -y
    
    - name: Install rabbitmq-server and its dependencies
      command: sudo apt-get install rabbitmq-server -y --fix-missing
